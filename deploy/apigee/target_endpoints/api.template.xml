<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<TargetEndpoint name="api">
  <Description />
  <FaultRules>
    <FaultRule name="handle_FailedToResolveApiKey">
      <Step>
        <Name>rewrite-missing-key-message</Name>
      </Step>
      <Condition>(fault.name = "FailedToResolveAPIKey")</Condition>
    </FaultRule>
    <FaultRule name="handle_Response405WithoutAllowHeader">
      <Step>
        <Name>rewrite-missing-allow-header-error</Name>
      </Step>
      <Condition>(fault.name = "Response405WithoutAllowHeader")</Condition>
    </FaultRule>
    <FaultRule name="handle_QuotaExceeded">
      <Condition>(fault.name = "QuotaViolation")</Condition>
      <Step>
        <Name>rewrite-quota-exceeded-message</Name>
      </Step>
    </FaultRule>
  </FaultRules>
  <PreFlow name="PreFlow">
    <Request>
      <Step>
        <Condition>(request.header.x-api-key = null) and (request.queryparam.key != null)</Condition>
        <Name>copy-key-param-to-header</Name>
      </Step>
    </Request>
    <Response />
  </PreFlow>
  <Flows>
    <Flow name="EnforceRestrictions">
      <Request>
        <Step>
          <Condition>
            (proxy.pathsuffix MatchesPath "/v2/variable/filter") OR
            (proxy.pathsuffix MatchesPath "/v3/**")
          </Condition>
          <Name>block-internal-only-endpoints</Name>
        </Step>
        <Step>
          <Condition>
            (proxy.pathsuffix MatchesPath "/internal/bio") OR
            (proxy.pathsuffix MatchesPath "/internal/import-table") OR
            (proxy.pathsuffix MatchesPath "/place/stats-var") OR
            (proxy.pathsuffix MatchesPath "/translate") OR
            (proxy.pathsuffix MatchesPath "/update-cache") OR
            (proxy.pathsuffix MatchesPath "/v1/bulk/observation-existence") OR
            (proxy.pathsuffix MatchesPath "/v1/events") OR
            (proxy.pathsuffix MatchesPath "/v1/events/dates") OR
            (proxy.pathsuffix MatchesPath "/v1/observations/series/derived") OR
            (proxy.pathsuffix MatchesPath "/v1/stat/date/within-place")
          </Condition>
          <Name>block-deprecated-endpoints</Name>
        </Step>
       <Step>
          <!-- 
            Input Normalization:
            For POST requests to /v2/resolve, we force the Content-Type to application/json if it isn't already.
            This handles "curl -d" (form-urlencoded), text/plain, or null headers.
            This ensures:
            1. The 'extract-json-params' policy below ALWAYS runs (it requires JSON).
            2. The backend receives JSON (preventing 415 errors for valid JSON with wrong headers).
            3. Invalid bodies (e.g. actual form data) will fail safely at the backend with 400 Bad Request.
          -->
          <Condition>(request.verb = "POST") and (proxy.pathsuffix MatchesPath "/v2/resolve") and !(request.header.Content-Type ~~ "^application/json.*")</Condition>
          <Name>set-content-type-to-json</Name>
       </Step>
        <Step>
          <!--
            Security Parameter Extraction:
            We parse the JSON body to check for the 'resolver' parameter.
            This is critical because /v2/resolve has a "Public" (Legacy) mode only if 'resolver' is NOT present.
            If this extraction fails (e.g. invalid JSON), the variable remains null, but the Public check
            (defined in verify-api-key-in-header) will explicitly fail-safe unless it's a valid legacy request.
          -->
          <Condition>(request.verb = "POST") and (proxy.pathsuffix MatchesPath "/v2/resolve")</Condition>
          <Name>extract-json-params</Name>
        </Step>
        <Step>
          <Condition>
            <!-- List of endpoints that do NOT require a key -->
            !(
              (proxy.pathsuffix MatchesPath "/bulk/stats") OR
              (proxy.pathsuffix MatchesPath "/node/places-in") OR
              (proxy.pathsuffix MatchesPath "/node/property-labels") OR
              (proxy.pathsuffix MatchesPath "/node/property-values") OR
              (proxy.pathsuffix MatchesPath "/node/triples") OR
              (proxy.pathsuffix MatchesPath "/place/stat-vars") OR
              (proxy.pathsuffix MatchesPath "/place/stat/date/within-place") OR
              (proxy.pathsuffix MatchesPath "/query") OR
              (proxy.pathsuffix MatchesPath "/search") OR
              (proxy.pathsuffix MatchesPath "/stat/all") OR
              (proxy.pathsuffix MatchesPath "/stat/series") OR
              (proxy.pathsuffix MatchesPath "/stat/value") OR
              (proxy.pathsuffix MatchesPath "/v1/place/ranking") OR
              (proxy.pathsuffix MatchesPath "/v1/place/related") OR
              (proxy.pathsuffix MatchesPath "/v1/place/stat-vars/union") OR
              (proxy.pathsuffix MatchesPath "/v1/recon/entity/resolve") OR
              (proxy.pathsuffix MatchesPath "/v1/recon/resolve/coordinate") OR
              (proxy.pathsuffix MatchesPath "/v1/recon/resolve/id") OR
              (proxy.pathsuffix MatchesPath "/v1/variable/search") OR
              <!-- /v2/resolve is public ONLY for legacy requests (no 'resolver' param). -->
              ((proxy.pathsuffix MatchesPath "/v2/resolve") AND (request.queryparam.resolver Is null) AND (extracted_json_param_resolver Is null)) OR
              (proxy.pathsuffix MatchesPath "/version") OR
              (proxy.pathsuffix MatchesPath "/healthz")
            )
          </Condition>
          <Name>verify-api-key-in-header</Name>
        </Step>
        <Step>
          <Condition>
            (client_id != null) AND
            (client_id != "") AND
            (client_id = "REPLACE_WITH_TRIAL_API_KEY")
          </Condition>
          <Name>enforce-quota-limit</Name>
        </Step>
      </Request>
    </Flow>
  </Flows>
  <PostFlow name="PostFlow">
    <Request>
      <Step>
        <Name>strip-api-key-header-and-params</Name>
      </Step>
      <Step>
        <Condition>
          <!-- /healthz only works when a key is NOT present --> !(proxy.pathsuffix MatchesPath "/healthz") </Condition>
        <Name>set-southbound-key</Name>
      </Step>
    </Request>
    <Response />
  </PostFlow>
  <HTTPTargetConnection>
    <Properties>
      <Property name="response.streaming.enabled">true</Property>
    </Properties>
    <URL>https://REPLACE_WITH_MIXER_API_ESP_HOSTNAME</URL>
    <SSLInfo>
      <Enabled>true</Enabled>
    </SSLInfo>
  </HTTPTargetConnection>
</TargetEndpoint>
