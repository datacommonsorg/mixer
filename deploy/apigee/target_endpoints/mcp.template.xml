<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<TargetEndpoint name="mcp">
  <Description>Secure connection to MCP Cloud Run Service</Description>
  <FaultRules>
    <FaultRule name="handle_FailedToResolveApiKey">
      <Step>
        <Name>rewrite-missing-key-message</Name>
      </Step>
      <Condition>(fault.name = "FailedToResolveAPIKey")</Condition>
    </FaultRule>
  </FaultRules>
  <PreFlow name="PreFlow">
    <Request>
      <Step>
        <Condition>(request.header.x-api-key = null) and (request.queryparam.key != null)</Condition>
        <Name>copy-key-param-to-header</Name>
      </Step>
      <Step>
        <Name>verify-api-key-in-header</Name>
      </Step>
    </Request>
    <Response />
  </PreFlow>
  <Flows />
  <PostFlow />
  <HTTPTargetConnection>
    <URL>https://REPLACE_WITH_MCP_SERVICE_URL</URL>
    <Properties>
      <Property name="response.streaming.enabled">true</Property>
      <Property name="io.timeout.millis">300000</Property>
      <Property name="api.timeout">86400000</Property>
    </Properties>
    <Authentication>
      <GoogleIDToken>
        <Audience>https://REPLACE_WITH_MCP_SERVICE_URL</Audience>
      </GoogleIDToken>
    </Authentication>
  </HTTPTargetConnection>
</TargetEndpoint>
